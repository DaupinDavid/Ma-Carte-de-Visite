<!DOCTYPE html>
<html class="dark" lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DUAL RIDE - Moteur de D√©cision</title>

    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300..700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">

    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>

    <style>
        .material-symbols-outlined {
            font-variation-settings: 'FILL'0, 'wght'400, 'GRAD'0, 'opsz'24;
        }

        button:focus,
        textarea:focus,
        details summary:focus {
            outline: 3px solid #135bec;
            outline-offset: 2px;
        }

        button,
        textarea,
        details summary {
            transition: outline 0.2s ease-in-out;
        }

        /* Custom style for XAI status */
        .xai-status {
            font-size: 0.75rem;
            line-height: 1rem;
            font-weight: 700;
            padding: 0.15rem 0.5rem;
            border-radius: 9999px;
            margin-left: 0.5rem;
        }
        /* Style ajout√© pour la clart√© du feedback (10/10) */
        .xai-feedback-msg {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }
    </style>

    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        primary: "#135bec",
                        "background-light": "#f6f6f8",
                        "background-dark": "#101622",
                    },
                    fontFamily: {
                        display: ["Space Grotesk", "sans-serif"]
                    },
                }
            }
        }
    </script>
</head>

<body class="bg-background-light dark:bg-background-dark font-display">
    <div class="relative flex flex-col min-h-screen w-full">

        <header class="flex items-center justify-between border-b border-white/10 dark:border-[#232f48] px-6 py-3">
            <div class="flex items-center gap-4">
                <div class="text-primary" aria-hidden="true">
                    <svg fill="none" viewBox="0 0 48 48" class="size-6">
                        <path
                            d="M36.7 44c-2.7 0-5.1-4.2-6.3-10.3C29.2 39.8 26.7 44 24 44c-2.7 0-5.1-4.2-6.3-10.3C16.4 39.8 14 44 11.3 44 7.3 44 4 35 4 24S7.3 4 11.3 4c2.7 0 5.1 4.2 6.3 10.3C18.9 8.2 21.3 4 24 4c2.7 0 5.1 4.2 6.3 10.3C31.6 8.2 34 4 36.7 4 40.7 4 44 13 44 24s-3.3 20-7.3 20Z"
                            fill="currentColor" />
                    </svg>
                </div>
                <h1 class="text-white text-lg font-bold">DUAL RIDE (Moteur de D√©cision)</h1>
            </div>

            <div class="flex items-center gap-4">
                <span id="final-xai-score" class="px-3 py-1 rounded-full bg-primary text-white text-sm font-bold">SCORE RENTABILIT√â : N/A</span>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 xl:grid-cols-4 gap-4 p-4 lg:p-6 flex-1">

            <aside class="col-span-1 flex flex-col gap-4">

                <div class="flex-1 flex flex-col gap-3 rounded-lg bg-white/5 dark:bg-[#111722]/80 p-4 border border-white/10">

                    <details class="bg-white/5 dark:bg-[#232f48] rounded-lg px-4 py-2" open>
                        <summary class="cursor-pointer flex justify-between items-center py-2">
                            <p class="text-white text-sm font-medium">Moteur & Contraintes
                                <span id="euro5-status" class="xai-status bg-green-700 text-white">EURO 5 CONFORME</span>
                            </p>
                            <span class="material-symbols-outlined text-white">expand_more</span>
                        </summary>
                        <div class="pt-4 border-t border-white/10 space-y-3">
                            <p class="text-white/60 text-sm">Choix d'√âchappement :</p>
                            <select id="exhaust-option" onchange="updateConfig()"
                                class="form-select rounded-lg bg-white/10 text-white border border-white/10">
                                <option value="std">Standard (Faible Co√ªt)</option>
                                <option value="race">Sport Carbone (+ Risque ZFE)</option>
                                <option value="titanium">Titanium Haute Qualit√©</option>
                            </select>

                            <div id="constraint-feedback" class="xai-feedback-msg text-red-400 text-sm h-4"></div>
                        </div>
                    </details>

                    <details class="bg-white/5 dark:bg-[#232f48] rounded-lg px-4 py-2" open>
                        <summary class="cursor-pointer flex justify-between items-center py-2">
                            <p class="text-white text-sm font-medium">Car√©nage & Logistique
                                <span id="mould-status" class="xai-status bg-yellow-600 text-white">MOULE SIMPLE</span>
                            </p>
                            <span class="material-symbols-outlined text-white">expand_more</span>
                        </summary>
                        <div class="pt-4 border-t border-white/10 space-y-3">
                            <p class="text-white/60 text-sm">Type de Car√©nage (Impact Logistique) :</p>
                            <select id="fairing-type" onchange="updateConfig()"
                                class="form-select rounded-lg bg-white/10 text-white border border-white/10">
                                <option value="simple">R√©tro Simple (Moule Simple)</option>
                                <option value="complex">Cyber-Punk (Moule Complexe)</option>
                            </select>

                            <div id="counterfactual-feedback" class="xai-feedback-msg text-blue-400 text-sm font-medium h-6"></div>
                            <p class="text-white/60 text-sm mt-3">Co√ªt Logistique Estim√© : <span id="logistics-cost"
                                    class="text-white font-bold">50 ‚Ç¨</span></p>
                        </div>
                    </details>
                    
                    <details class="bg-white/5 dark:bg-[#232f48] rounded-lg px-4 py-2">
                        <summary class="cursor-pointer flex justify-between items-center py-2">
                            <p class="text-white text-sm font-medium">Couleur & Finition</p>
                            <span class="material-symbols-outlined text-white">expand_more</span>
                        </summary>
                        <div class="pt-4 border-t border-white/10">
                            <p class="text-white/60 text-sm pb-3">Choisissez la couleur.</p>
                            <div class="flex gap-3 flex-wrap">
                                <button class="size-8 rounded-full bg-[#ff4747] ring-2 ring-primary" aria-label="Rouge"></button>
                                <button class="size-8 rounded-full bg-[#476eff]" aria-label="Bleu"></button>
                                <button class="size-8 rounded-full bg-[#47ffa7]" aria-label="Vert"></button>
                                <button class="size-8 rounded-full bg-[#f5f5f5]" aria-label="Blanc"></button>
                                <button class="size-8 rounded-full bg-[#2c2c2c]" aria-label="Noir"></button>
                            </div>
                        </div>
                    </details>
                </div>
                
                <div class="rounded-lg bg-white/5 p-4 border border-white/10">
                    <p class="text-slate-400 text-sm">BUDGET OPTIMISATION</p>
                    <div class="flex justify-between items-center mt-1">
                        <p class="text-white text-xl font-bold">Prix Total Estim√© :</p>
                        <p id="total-price" class="text-2xl font-black text-primary">8 450 ‚Ç¨</p>
                    </div>
                    <div id="optimal-recommendation" class="mt-3 p-3 bg-primary/20 text-white rounded-lg text-xs font-medium">
                        ‚úÖ Recommandation Optimale : Faisabilit√© Totale. Marge Industrielle : 18.2%.
                    </div>
                </div>

                <div class="flex flex-col gap-4 rounded-lg bg-white/5 p-4 border border-white/10">
                    <label class="flex flex-col">
                        <p class="text-white text-base font-medium">DEMANDE CLIENT (Moteur de D√©cision)</p>
                        <textarea id="client-demand"
                            class="form-input rounded-lg bg-white/5 text-white border border-white/10 p-3 min-h-24"
                            placeholder="D√©crivez ici toute demande particuli√®re..." aria-label="Demande client"></textarea>
                    </label>

                    <div id="agent-feedback" role="status" aria-live="polite" class="h-6 text-sm text-green-400 font-medium"></div>

                    <button onclick="showFinalSummary()"
                        class="h-12 bg-primary text-white font-bold rounded-lg hover:bg-primary/90 transition"
                        aria-label="Afficher la synth√®se finale">
                        9. STORYTELLING STRAT√âGIQUE (Synth√®se Finale)
                    </button>
                </div>

            </aside>

            <section class="lg:col-span-2 xl:col-span-3 flex flex-col gap-4">
                <div
                    class="relative flex flex-col items-center justify-center bg-white/5 dark:bg-[#111722]/80 border border-white/10 rounded-lg p-4 min-h-[400px]">

                    <model-viewer src="ma_moto.glb" camera-controls auto-rotate alt="MT-09 visualisation 3D"
                        style="width:100%; height:500px;" shadow-intensity="1" loading="eager" environment-image="neutral">
                        <p class="text-white text-center mt-4">Votre navigateur ne supporte pas la visualisation 3D.</p>
                    </model-viewer>

                    <div id="xai-best-match" class="absolute top-4 left-4 p-3 bg-white/10 rounded-lg text-sm text-white">
                        <p class="font-bold">7. Best Match (Simul√©) :</p>
                        <p class="text-green-400">Proche du profil N√©o-R√©tro 90s (98/100)</p>
                    </div>

                    <div class="absolute bottom-4 text-center">
                        <p class="text-white/60 text-sm">VISUALISATION 3D</p>
                        <p class="text-white/40 text-xs">Rotation / Zoom / Pan</p>
                        <div id="morpho-check" class="xai-feedback-msg text-green-400 text-sm font-medium mt-1">‚úì Compatibilit√© Morphologique OK</div>
                    </div>
                </div>
            </section>

        </main>

    </div>
    
    <div id="final-summary-modal" class="fixed inset-0 bg-black/80 hidden items-center justify-center p-4 z-50">
        <div class="bg-[#111722] p-8 rounded-xl shadow-2xl max-w-lg w-full border border-primary">
            <h2 class="text-2xl font-black text-primary mb-4">SYNTH√àSE FINALE & CONSEIL STRAT√âGIQUE</h2>
            
            <div id="narrative-summary" class="text-white space-y-4">
                <p><strong>R√âSUM√â NARRATIF (Gemini) :</strong> Votre configuration est un excellent point d'√©quilibre. Elle r√©pond au d√©sir esth√©tique "N√©o-R√©tro 90s" tout en garantissant la fiabilit√© et la l√©galit√© exig√©es par le march√© moderne.</p>
                
                <p class="text-slate-400 text-sm"><strong>ANALYSE DE SENSIBILIT√â (12. Robustesse) :</strong> La configuration est stable. Un changement de couleur n'a qu'un impact logistique mineur (-48‚Ç¨), mais tout ajout de car√©nage complexe pourrait r√©duire la marge industrielle de 12%.</p>
                
                <button onclick="hideSummaryAndLogFeedback()" class="mt-6 px-4 py-2 bg-primary text-white rounded-lg font-bold">Fermer & Continuer</button>
            </div>
        </div>
    </div>


    <script>
        // √âtat initial de la configuration
        let configState = {
            mould: 'simple',
            exhaust: 'std',
            basePrice: 8000,
            logisticsCost: 50,
            margePercent: 18.2,
            finalPrice: 8450
        };
        
        // --- PILIER 13: XAI MONITORING & LOGGING (Gouvernance) ---
        function logXAIAction(action, detail) {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] XAI_LOG: ${action} | D√©tail: ${detail}`);
        }

        // --- PILIER 14: XAI FEEDBACK LOOP (Gouvernance) ---
        function hideSummaryAndLogFeedback() {
            document.getElementById('final-summary-modal').classList.add('hidden');
            // Simulation du retour utilisateur pour am√©liorer le mod√®le XAI
            logXAIAction("FEEDBACK_LOOP", "Synth√®se lue et ferm√©e par l'utilisateur.");
        }


        // Fonction pour mettre √† jour la configuration et le XAI
        function updateConfig() {
            const exhaust = document.getElementById('exhaust-option').value;
            const fairingType = document.getElementById('fairing-type').value;
            
            let priceChange = 0;
            let constraintFeedback = '';
            let counterfactual = '';
            let mouldStatus = 'MOULE SIMPLE';

            // --- 3. V√âRIFICATION DES CONTRAINTES ZFE / EURO 5/6 & XAI 1 ---
            if (exhaust === 'race') {
                // Contrainte fail
                constraintFeedback = '‚ùå Risque ZFE : √âchappement Sport non compatible.';
                document.getElementById('euro5-status').className = 'xai-status bg-red-700 text-white';
                document.getElementById('euro5-status').innerText = 'RISQUE ZFE';
                logXAIAction("CONSTRAINT_FAIL", `√âchappement 'race' s√©lectionn√©.`);
            } else {
                // Contrainte pass
                constraintFeedback = '';
                document.getElementById('euro5-status').className = 'xai-status bg-green-700 text-white';
                document.getElementById('euro5-status').innerText = 'EURO 5 CONFORME';
            }

            // --- 4. COMPATIBILIT√â MORPHOLOGIQUE 3D (Simulation) ---
            if (fairingType === 'complex' && exhaust === 'race') {
                document.getElementById('morpho-check').innerHTML = '‚ùå Collision structurelle d√©tect√©e !';
                document.getElementById('morpho-check').classList.add('text-red-400');
                document.getElementById('morpho-check').classList.remove('text-green-400');
                logXAIAction("MORPHO_FAIL", "Car√©nage 'complex' incompatible avec √©chappement 'race'.");
            } else {
                document.getElementById('morpho-check').innerHTML = '‚úì Compatibilit√© Morphologique OK';
                document.getElementById('morpho-check').classList.remove('text-red-400');
                document.getElementById('morpho-check').classList.add('text-green-400');
            }


            // --- 10. COST BREAKDOWN INDUSTRIEL ---
            if (fairingType === 'complex') {
                priceChange += 600; // Co√ªt du moule complexe
                configState.logisticsCost = 120;
                mouldStatus = 'MOULE COMPLEXE';
                
                // --- 2. CONTREFACTUELS ATOMIQUES (WHAT-IF INSTANTAN√â) ---
                counterfactual = 'üí° Contrefactuel : Passez au Car√©nage Simple pour +12% de Marge Industrielle.';
                
            } else {
                priceChange += 50; // Co√ªt du moule simple
                configState.logisticsCost = 50;
                counterfactual = '';
            }

            // Mettre √† jour l'√©tat et l'affichage
            configState.finalPrice = configState.basePrice + priceChange;
            document.getElementById('total-price').innerText = `${configState.finalPrice.toLocaleString('fr-FR')} ‚Ç¨`;
            document.getElementById('logistics-cost').innerText = `${configState.logisticsCost} ‚Ç¨`;
            document.getElementById('constraint-feedback').innerHTML = constraintFeedback;
            document.getElementById('counterfactual-feedback').innerHTML = counterfactual;
            document.getElementById('mould-status').innerText = mouldStatus;

            // Log de la configuration actuelle
            logXAIAction("CONFIG_UPDATE", `Nouveau Prix: ${configState.finalPrice} | Moule: ${mouldStatus}`);
        }

        function analyseConfig() {
            const demand = document.getElementById('client-demand').value;
            const feedbackDiv = document.getElementById('agent-feedback');
            
            let classification = 'Analyse en cours...';

            // --- Simulation de l'Agent Gemini pour la Classification (Couche 3 & 2) ---
            if (demand.toLowerCase().includes('akira') || demand.toLowerCase().includes('cyberpunk')) {
                // XAI 1 (Attribution Hybride) et 7 (Worst Match)
                classification = 'Cyber-Punk 90s, ROUGE (Risque √©lev√©)';
                document.getElementById('xai-best-match').innerHTML = `<p class="font-bold">7. Worst Match (Simul√©) :</p><p class="text-red-400">Proche du profil Cyber-Punk (45/100)</p>`;
                document.getElementById('final-xai-score').innerText = 'SCORE RENTABILIT√â : 45/100';
            } else if (demand.toLowerCase().includes('pas cher') || demand.toLowerCase().includes('budget')) {
                // XAI 1 (Attribution Hybride) et 7 (Best Match)
                classification = 'N√©o-R√©tro 90s, VERT (Faible co√ªt)';
                document.getElementById('xai-best-match').innerHTML = `<p class="font-bold">7. Best Match (Simul√©) :</p><p class="text-green-400">Proche du profil N√©o-R√©tro 90s (98/100)</p>`;
                document.getElementById('final-xai-score').innerText = 'SCORE RENTABILIT√â : 98/100';
            } else {
                // XAI 1 (Attribution Hybride) et 7 (Best Match)
                classification = 'N√©o-R√©tro 90s, VERT (Valid√©)';
                document.getElementById('xai-best-match').innerHTML = `<p class="font-bold">7. Best Match (Simul√©) :</p><p class="text-green-400">Proche du profil N√©o-R√©tro 90s (98/100)</p>`;
                document.getElementById('final-xai-score').innerText = 'SCORE RENTABILIT√â : 98/100';
            }

            feedbackDiv.innerHTML = `‚úÖ Agent Gemini : Tags extraits : ${classification}`;
            logXAIAction("DEMAND_ANALYSIS", `Demande client: "${demand}"`);
        }
        
        function showFinalSummary() {
             document.getElementById('final-summary-modal').classList.remove('hidden');
        }

        // Initialisation de la configuration au chargement
        document.addEventListener('DOMContentLoaded', updateConfig);
    </script>
</body>

</html>